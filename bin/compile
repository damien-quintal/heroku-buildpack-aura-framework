#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -o errexit
set -o pipefail
set -o nounset
unset GIT_DIR

function message() {
  echo "-----> $*..."
}

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

BIN_DIR=$BUILD_DIR/aura
mkdir -p $BIN_DIR

cd $BIN_DIR

if [ ! -d aura ]; then
  heroku git:clone -a git@github.com:forcedotcom/aura.git
fi

message "Move to aura repo and fetch latest"
cd aura
git fetch
git fetch --all --tags --prune
git pull origin master

message "Looking up latest aura framework tag"
LATEST=`git describe --tags --match='v0.*' $(git rev-list --tags --max-count=1)`
message "Tag $LATEST"

message "Checkout latest tag"
git checkout tags/$LATEST -b "$LATEST"
message "Tag checked out"

message "Maven clean and install"
mvn clean install
message "Maven install complete"

message "Start jetty server"
./bin/jetty-start
message "Aura Framework running!"